= Build your first application

include::ROOT:partial$include.adoc[]

This guide will walk you through the process of setting up your environment, generating a project, and implementing a simple application. By the end, you will have a functional Shopping Cart application built with the Akka SDK.

== Overview

The Akka SDK comes with Maven support that enables you to get started quickly. In this guide, you will:

* Use the Akka Maven archetype to generate a skeleton project that follows the recommended onion architecture.
* Understand how to use the Akka Maven parent POM to define dependencies and run your application locally.

== Prerequisites

include::ROOT:partial$cloud-dev-prerequisites.adoc[]


== Generate and build the skeleton project

The Maven archetype template prompts you to specify the project's group ID, name and version interactively. Run it using the commands shown for your OS.

[sidebar]
In IntelliJ, you can skip the command line. Open the IDE, select
*File > New > Project*, and click to activate *Create from archetype*. Use the UI to locate the archetype and fill in the blanks.

Follow these steps to generate and build your project:

. From a command line, run the template in a convenient location:
+
[.tabset]
Linux or macOS::
+
--
[source,command line, subs="attributes"]
----
mvn archetype:generate \
  -DarchetypeGroupId=io.akka \
  -DarchetypeArtifactId=akka-javasdk-archetype \
  -DarchetypeVersion={akka-javasdk-version}
----
--
Windows 10+::
+
--
[source,command line, subs="attributes"]
----
mvn archetype:generate ^
  -DarchetypeGroupId=io.akka ^
  -DarchetypeArtifactId=akka-javasdk-archetype ^
  -DarchetypeVersion={akka-javasdk-version}
----
--

. Fill in
* groupId: `com.example`
* artifactId: `shoppingcart`
* version: `1.0-SNAPSHOT`
* package: `shoppingcart`

. Navigate to the new project directory.

. Open it in your preferred IDE / Editor.

== Implementing first component

Akka has different kinds of components that you can use to implement your application.
The list of components are:

* xref:java:event-sourced-entities.adoc[Event Sourced Entities]
* xref:java:key-value-entities.adoc[Key Value Entities]
* xref:java:http-endpoints.adoc[HTTP Endpoints]
* xref:java:views.adoc[Views]
* xref:java:workflows.adoc[Workflows]
* xref:java:timed-actions.adoc[Timers]
* xref:java:consuming-producing.adoc[Consumers]

For this *Getting started* walk-through, we will implement a Shopping Cart based on an Event Sourced Entity.

Through our "Shopping Cart" Event Sourced Entity we expect to manage our cart, adding and removing items as we please. Being event-sourced means it will represent changes to state as a series of domain events. Letâ€™s have a look at what kind of model we expect to store and the events our entity might generate.

=== Define the domain model

First, define the domain class `ShoppingCart` in package `shoppingcart.domain`. This class should be located in the `src/main/java/shoppingcart/domain/` directory and saved as `ShoppingCart.java`. 

[source,java,indent=0]
.{sample-base-url}/shopping-cart-quickstart/src/main/java/shoppingcart/domain/ShoppingCart.java[ShoppingCart.java]
----
include::example$shopping-cart-quickstart/src/main/java/shoppingcart/domain/ShoppingCart.java[tags=first-app-top-part-1;domain]
----
<1> Our `ShoppingCart` is fairly simple, being composed only by a `cartId` and a list of line items.
<2> A `LineItem` represents a single product and the quantity we intend to buy.

Next, let's define a domain event for adding items to the cart. Add an interface `ShoppingCartEvent` with the `ItemAdded` domain event in package `shoppingcart.domain`. This class should be located in the `src/main/java/shoppingcart/domain/` directory and saved as `ShoppingCartEvent.java`:

[source,java,indent=0]
.{sample-base-url}/shopping-cart-quickstart/src/main/java/shoppingcart/domain/ShoppingCartEvent.java[ShoppingCartEvent.java]
----
include::example$shopping-cart-quickstart/src/main/java/shoppingcart/domain/ShoppingCartEvent.java[tags=top;domain]
----
<1> `ItemAdded` event derives from the `ShoppingCartEvent` interface.
<2> Specifying a logical type name, required for serialization.

Jumping back to the `ShoppingCart` domain class, add business logic to handle the `ItemAdded` domain event for adding items to the cart:

[source,java,indent=0]
.{sample-base-url}/shopping-cart-quickstart/src/main/java/shoppingcart/domain/ShoppingCart.java[ShoppingCart.java]
----
include::example$shopping-cart-quickstart/src/main/java/shoppingcart/domain/ShoppingCart.java[tag=itemAdded]
----
<1> For an existing item, we will make sure to sum the existing quantity with the incoming one.
<2> Returns an update list of items without the existing item.
<3> Adds the update item to the shopping cart.
<4> Returns a new instance of the shopping cart with the updated line items.

If your integrated development environment (IDE) did not detect it, you may need to add the following imports manually:

[source,java,indent=0]
.{sample-base-url}/shopping-cart-quickstart/src/main/java/shoppingcart/domain/ShoppingCart.java[ShoppingCart.java]
----
include::example$shopping-cart-quickstart/src/main/java/shoppingcart/domain/ShoppingCart.java[tag=first-app-top-part-2]
----

=== Define the entity

Create an Event Sourced Entity named `ShoppingCartEntity` in package `shoppingcart.application`. This class should be located in the `src/main/java/shoppingcart/application/` directory and saved as `ShoppingCartEntity.java`. The class signature should look like this:

[source,java]
.{sample-base-url}/shopping-cart-quickstart/src/main/java/shoppingcart/application/ShoppingCartEntity.java[ShoppingCartEntity.java]
----
include::example$shopping-cart-quickstart/src/main/java/shoppingcart/application/ShoppingCartEntity.java[tags=top;class]
----
<1> Extend `EventSourcedEntity<ShoppingCart, ShoppingCartEvent>`, where `ShoppingCart` is the type of state this entity will store, and `ShoppingCartEvent` is the interface for the events it persists.
<2> Annotate the class so Akka can identify it as an Event Sourced Entity.

At this point, you may encounter an error stating:
`The type ShoppingCartEntity must implement the inherited abstract method EventSourcedEntity<ShoppingCart,ShoppingCartEvent>.applyEvent(ShoppingCartEvent).`
This error is expected, and we will implement this abstract method in the next step.

Inside `ShoppingCartEntity`, define an `addItem` command handler to generate an `ItemAdded` event, and an event handler to process the event:

[source,java]
.{sample-base-url}/shopping-cart-quickstart/src/main/java/shoppingcart/application/ShoppingCartEntity.java[ShoppingCartEntity.java]
----
include::example$shopping-cart-quickstart/src/main/java/shoppingcart/application/ShoppingCartEntity.java[tag=addItem]
----
<1> Validate the quantity of items added is greater than zero.
<2> Create a new `ItemAdded` event representing the change to the state of the cart.
<3> Persist the event by returning an `Effect` with `effects().persist`.
<4> Acknowledge that the event was successfully persisted.
<5> Event handler to process the `ItemAdded` event and return the updated state.

Inside `ShoppingCartEntity`, define a `getCart` command handler to retrieve the state of the shopping cart:

[source,java,indent=0]
.{sample-base-url}/shopping-cart-quickstart/src/main/java/shoppingcart/application/ShoppingCartEntity.java[ShoppingCartEntity.java]
----
include::example$shopping-cart-quickstart/src/main/java/shoppingcart/application/ShoppingCartEntity.java[tag=getCart]
----
<1> Store the `entityId` in an internal attribute, to be used elsewhere.
<2> Define the initial state.
<3> Return the current state as a reply to the request.


=== Define the external API

The shopping cart API is defined by the `ShoppingCartEndpoint`.

Create a class named `ShoppingCartEndpoint` in package `shoppingcart.api`. This class should be located in the `src/main/java/shoppingcart/api/` directory and saved as `ShoppingCartEndpoint.java`:

[source,java,indent=0]
.{sample-base-url}/shopping-cart-quickstart/src/main/java/shoppingcart/api/ShoppingCartEndpoint.java[ShoppingCartEndpoint.java]
----
include::example$shopping-cart-quickstart/src/main/java/shoppingcart/api/ShoppingCartEndpoint.java[tags=top;class;get;addItem]
----
<1> Annotate the class so Akka can identify it as an Endpoint with a common path prefix for all methods `/carts`.
<2> `ComponentClient` utility enables components to interact with each other.
<3> GET endpoint path is combined with a path parameter name, e.g. `/carts/123`.
<4> `ComponentClient` calling a command handler on an Event Sourced Entity from inside an Endpoint.
<5> Result of request is a `CompletionStage<T>`, in this case a `CompletionStage<ShoppingCart>`.
<6> Use path parameter `{cartId}` in combination with request body `ShoppingCart.LineItem`.
<7> Map request to a more suitable response, in this case an `HTTP 200 OK` response.

== Run locally

Start your service locally:

[source,bash]
----
mvn compile exec:java
----

Once successfully started, any defined endpoints become available at `localhost:9000`.

Let's send some requests using `curl`.

Add some T-shirts to a shopping cart:

[source, command line]
----
curl -i -XPUT -H "Content-Type: application/json" localhost:9000/carts/123/item -d '
{"productId":"akka-tshirt", "name":"Akka Tshirt", "quantity": 3}'
----

Add some blue jeans to the shopping cart:

[source, command line]
----
curl -i -XPUT -H "Content-Type: application/json" localhost:9000/carts/123/item -d '
{"productId":"blue-jeans", "name":"Blue Jeans", "quantity": 2}'
----

Add a few more T-shirts to the shopping cart:

[source, command line]
----
curl -i -XPUT -H "Content-Type: application/json" localhost:9000/carts/123/item -d '
{"productId":"akka-tshirt", "name":"Akka Tshirt", "quantity": 3}'
----

Request to see all of the items in the cart:

[source, command line]
----
curl localhost:9000/carts/123
----

Observe all of the items in the cart:

[source]
----
{"cartId":"123","items":[{"productId":"akka-tshirt","name":"Akka Tshirt","quantity":6},
{"productId":"blue-jeans","name":"Blue Jeans","quantity":5}],"checkedOut":false}
----


== Explore the local console

To get a clear view of your locally running service, xref:akka-cli:installation.adoc[install the Akka CLI]. It provides a local web-based management console.

After you have installed the CLI, start the local console:

[source, command line]
----
akka local console
----

This will start a Docker container running the local console:

[source]
----
> Local Console is running at:             http://localhost:3000
 - shopping-cart-quickstart is running at: localhost:9000
--------------------
----

You can open http://localhost:3000/[window="new"] to see your local service in action:

image:local-console-first-app-events.png[]

Here, you can view not only the http://localhost:3000/services/shopping-cart-quickstart/components/shoppingcart.application.ShoppingCartEntity[current state of the cart, window="new"], but also http://localhost:3000/services/shopping-cart-quickstart/components/shoppingcart.application.ShoppingCartEntity/eventlog/123[*a detailed log of events*, window="new"], and the corresponding state changes that occurred along the way.

== Deploy to akka.io

. If you have not already done so, xref:akka-cli:installation.adoc[install the Akka CLI].

. Authenticate the CLI with your Akka account:
[source, command line]
----
akka auth login
----

. Create a project:
[source, command line]
----
akka projects new my-first-app --region aws-us-east-2
----

Observe that your project was created successfully:
[source]
----
NAME          DESCRIPTION   ID                                     OWNER                   REGION
my-first-app                703391f5-cee4-4d50-8a7f-07c5d1183aaa   your-organization-name  aws-us-east-2

To make this the currently active project, run: 'akka config set project my-first-app'
----

. Make the project you just created the currently active project:
[source, command line]
----
akka config set project my-first-app
----

. Build a container image of your shopping cart service:
[source, command line]
----
mvn install -DskipTests
----

. Take note of the container name and tag from last line in the output, for example:

[source, command line]
----
DOCKER> Tagging image shoppingcart:1.0-SNAPSHOT-20241028102843 successful!
----

. Deploy your service, replacing:
* `my-service` with your service name
* `container-name` with the container name from the `mvn install` output in the previous step
* `tag-name` with the tag name from the `mvn install` output in the previous step

[source, command line]
----
akka service deploy cart-service shoppingcart:tag-name --push
----

Your service will now begin deploying.

. Verify the deployment status of your service:
+
[source, command line]
----
akka service list
----
+
A service status can be one of the following:

* *Ready*: All service instances are up-to-date and fully available.
* *UpdateInProgress*: Service is updating.
* *Unavailable*: No service instances are available.
* *PartiallyReady*: Some, but not all, service instances are available.

Approximately one minute after deploying, your service status should become *Ready*.

. Expose your service to the internet, replacing `my-service` with your service name:
[source,bash]
----
$ akka service expose my-service
Service 'cart-service' was successfully exposed at: spring-tooth-3406.us-east1.akka.app
----

Congratulations, you have successfully deployed your service. You can now access it using the hostname described in the output of the command above.

== Invoke your deployed service

[TBD](ifdef::todo[TODO: add service invocation steps])

== Download full sample

You can download the full source code of the Shopping Cart sample as a link:_attachments/shopping-cart-quickstart.zip[zip file].

== Next steps

Now that you've built and deployed a shopping cart service, take your Akka skills to the next level:

. *Expand the service*: Explore xref:concepts:architecture-model.adoc#_akka_components[other Akka components] to enhance your application with additional features.
. *Explore other Akka samples*: Discover more about Akka by exploring xref:samples.adoc[different use cases] for inspiration.
. *Join the community*: Visit the xref:support:index.adoc[Support page] to find resources where you can connect with other Akka developers and expand your knowledge.
